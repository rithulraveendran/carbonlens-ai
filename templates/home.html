<!DOCTYPE html>
<html lang="en"><head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Emissions Dashboard | CarbonLens AI</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
<script id="tailwind-config">
  tailwind.config = {
    darkMode: "class",
    theme: {
      extend: {
        colors: {
          "primary": "#7F00FF",
          "sidebar-bg": "#000000",
          "background-light": "#0B0B0F",
          "border-slate": "#E2E8F0"
        },
        fontFamily: {
          "display": ["Manrope", "sans-serif"]
        },
        borderRadius: {
          "DEFAULT": "0.25rem",
          "lg": "0.5rem",
          "xl": "0.75rem",
          "2xl": "1rem",
          "full": "9999px"
        },
      },
    },
  }
</script>
<style type="text/tailwindcss">
  body { font-family: 'Manrope', sans-serif; }
  .sidebar-item-active { background-color: rgba(255, 255, 255, 0.1); }
  #appSidebar {
    transform: translateX(-100%);
    transition: transform 0.2s ease-in-out;
  }
  #sidebarBackdrop {
    display: none;
  }
  body.sidebar-mobile-open #appSidebar {
    transform: translateX(0);
  }
  body.sidebar-mobile-open #sidebarBackdrop {
    display: block;
  }
  @media (min-width: 1024px) {
    #appSidebar {
      transform: translateX(0);
    }
    #appFrame {
      padding-left: 280px;
      transition: padding-left 0.2s ease-in-out;
    }
    body.sidebar-collapsed #appSidebar {
      transform: translateX(-100%);
    }
    body.sidebar-collapsed #appFrame {
      padding-left: 0;
    }
  }
</style>
<style>
  
  body { background: #000000 !important; color: #e5e7eb !important; }
  .bg-background-light, .bg-white, .bg-slate-50, .bg-slate-100, .bg-slate-200 { background-color: #000000 !important; }
  .dark\:bg-slate-900, .dark\:bg-slate-800, .dark\:bg-background-dark { background-color: #000000 !important; }
  .border, .border-slate-50, .border-slate-100, .border-slate-200, .border-slate-300, .border-border-ribbon, .border-gray, .ring-slate-50, .ring-slate-200 { border-color: #27272a !important; }
  .text-slate-900, .text-slate-800, .text-slate-700, .text-slate-600, .text-slate-500, .text-slate-400 { color: #e5e7eb !important; }  .placeholder\:text-slate-400::placeholder, .placeholder\:text-slate-500::placeholder { color: #9ca3af !important; }
  input, select, textarea { background-color: #0a0a0a !important; color: #f3f4f6 !important; border-color: #27272a !important; }
  table thead, table tbody tr, table tbody td, table tbody th { background-color: #000000 !important; }
</style>
</head>
<body class="bg-background-light text-slate-900 antialiased">
<div class="min-h-screen flex">
  <div id="sidebarBackdrop" class="fixed inset-0 z-40 bg-slate-900/40 lg:hidden"></div>
  <aside id="appSidebar" class="w-[280px] bg-sidebar-bg flex-shrink-0 flex flex-col text-white fixed inset-y-0 left-0 z-50">
    <div class="h-[72px] px-6 flex items-center gap-3">
      <div class="size-10 bg-white rounded-xl flex items-center justify-center">
        <span class="material-symbols-outlined text-primary text-2xl font-bold">eco</span>
      </div>
      <h1 class="text-xl font-bold tracking-tight">CarbonLens AI</h1>
    </div>
    <nav class="mt-4 flex-1 px-4 space-y-1">
      <a class="flex items-center gap-3 px-4 py-3 rounded-lg sidebar-item-active transition-colors" href="{{ url_for('home') }}">
        <span class="material-symbols-outlined text-[22px]">dashboard</span>
        <span class="text-sm font-semibold">Dashboard</span>
      </a>
      <a class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/5 transition-colors" href="{{ url_for('upload') }}">
        <span class="material-symbols-outlined text-[22px]">cloud_upload</span>
        <span class="text-sm font-semibold">Upload Documents</span>
      </a>
      <a class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/5 transition-colors" href="{{ url_for('suppliers_hub') }}">
        <span class="material-symbols-outlined text-[22px]">inventory</span>
        <span class="text-sm font-semibold">Suppliers</span>
      </a>
      <a class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/5 transition-colors" href="{{ url_for('reports') }}">
        <span class="material-symbols-outlined text-[22px]">description</span>
        <span class="text-sm font-semibold">Reports</span>
      </a>
      <a class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/5 transition-colors" href="{{ url_for('carbonlens_chat') }}">
        <span class="material-symbols-outlined text-[22px]">chat</span>
        <span class="text-sm font-semibold">AI Chat</span>
      </a>
      <a class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-white/5 transition-colors" href="{{ url_for('settings') }}">
        <span class="material-symbols-outlined text-[22px]">settings</span>
        <span class="text-sm font-semibold">Settings</span>
      </a>
    </nav>
    <div class="p-4 border-t border-white/10">
      <a href="{{ url_for('logout') }}" class="flex items-center gap-3 w-full px-4 py-3 rounded-lg hover:bg-white/10 transition-colors text-white/90">
        <span class="material-symbols-outlined text-[22px]">logout</span>
        <span class="text-sm font-semibold">Sign Out</span>
      </a>
    </div>
  </aside>

  <div id="appFrame" class="flex-1 flex flex-col min-w-0 overflow-hidden">
    <header class="h-[72px] bg-white border-b border-border-slate flex items-center justify-between px-4 sm:px-6 lg:px-8 z-10 flex-shrink-0 sticky top-0">
      <div class="flex items-center gap-3 min-w-0">
        <button id="sidebarToggle" type="button" class="inline-flex items-center justify-center size-10 rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50">
          <span class="material-symbols-outlined text-[22px]">menu</span>
        </button>
        <div class="min-w-0">
          <h2 class="text-sm font-bold text-slate-900 truncate">Dashboard</h2>
          <p class="text-xs text-slate-500 truncate">Scope 3 Emissions Dashboard</p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right">
          <p class="text-sm font-bold text-slate-900 leading-none">{{ user.name if user and user.name else 'User' }}</p>
          <p class="text-xs text-slate-500 font-medium mt-1">{{ user.role if user and user.role else 'Head of Sustainability' }}</p>
        </div>
        <div class="size-10 rounded-full bg-slate-100 overflow-hidden ring-1 ring-slate-200">
          <img alt="User Profile" class="w-full h-full object-cover" src="{{ url_for('static', filename='user.jpg') }}"/>
        </div>
      </div>
    </header>

    <main class="flex-1 overflow-y-auto p-4 sm:p-6 lg:p-8 space-y-8">
      {% with messages = get_flashed_messages(with_categories=true, category_filter=['error']) %}
        {% if messages %}
          <div class="space-y-2">
            {% for category, message in messages %}
              <div class="px-4 py-3 rounded-lg text-sm {% if category == 'error' %}bg-red-50 text-red-700 border border-red-100{% else %}bg-violet-50 text-violet-700 border border-violet-100{% endif %}">{{ message }}</div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

      <div>
        <h2 class="text-2xl font-bold text-slate-900">Scope 3 Emissions Dashboard</h2>
        <p class="text-slate-500 text-sm mt-1">Real-time monitoring and AI insights for your value chain.</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
          <div class="mb-4">
            <div class="inline-flex p-2 bg-primary/10 rounded-lg text-primary">
              <span class="material-symbols-outlined">co2</span>
            </div>
          </div>
          <p class="text-slate-500 text-sm font-medium">Total Emissions</p>
          <h3 class="text-2xl font-bold mt-1">{{ "{:,.2f}".format(metrics.total_emissions) }} <span class="text-sm text-slate-400 font-medium uppercase tracking-wider">tCO2e</span></h3>
        </div>
        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
          <div class="mb-4">
            <div class="inline-flex p-2 bg-blue-500/10 rounded-lg text-blue-500">
              <span class="material-symbols-outlined">inventory</span>
            </div>
          </div>
          <p class="text-slate-500 text-sm font-medium">Active Suppliers</p>
          <h3 class="text-2xl font-bold mt-1">{{ metrics.supplier_count }} <span class="text-sm text-slate-400 font-medium">Partners</span></h3>
        </div>
        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
          <div class="mb-4">
            <div class="inline-flex p-2 bg-amber-500/10 rounded-lg text-amber-500">
              <span class="material-symbols-outlined">verified_user</span>
            </div>
          </div>
          <p class="text-slate-500 text-sm font-medium">Documents Processed</p>
          <h3 class="text-2xl font-bold mt-1">{{ metrics.total_documents }}</h3>
        </div>
        <div class="bg-white p-6 rounded-xl border border-slate-200 shadow-sm">
          <div class="mb-4">
            <div class="inline-flex p-2 bg-purple-500/10 rounded-lg text-purple-500">
              <span class="material-symbols-outlined">pie_chart</span>
            </div>
          </div>
          <p class="text-slate-500 text-sm font-medium">Data Coverage</p>
          <h3 class="text-2xl font-bold mt-1">{{ metrics.avg_coverage }}%</h3>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-10 gap-6">
        <div class="lg:col-span-7 bg-white p-6 rounded-xl border border-slate-200 shadow-sm flex flex-col">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h4 class="text-lg font-bold">Emission Trends</h4>
              <p class="text-sm text-slate-500">Supplier emission profile from current processed data</p>
            </div>
          </div>
          <div class="flex-1 min-h-[300px]">
            <canvas id="scope3LineChart" class="w-full h-full"></canvas>
          </div>
        </div>

        <div class="lg:col-span-3 flex flex-col gap-4">
          <div class="bg-slate-900 text-white p-5 rounded-xl flex items-center gap-3 shadow-sm">
            <span class="material-symbols-outlined text-primary">psychology</span>
            <span class="font-bold">AI Insights</span>
          </div>

          {% if insights %}
            {% for item in insights %}
              <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                <div class="flex justify-between items-start mb-2">
                  <span class="text-[10px] font-bold px-2 py-0.5 rounded uppercase tracking-wider {% if 'Very High' in item.risk_level or 'High' in item.risk_level %}bg-red-50 text-red-700{% elif 'Moderate' in item.risk_level %}bg-amber-50 text-amber-700{% else %}bg-violet-50 text-violet-700{% endif %}">{{ item.risk_level }}</span>
                  <span class="material-symbols-outlined text-slate-300 text-lg">insights</span>
                </div>
                <h5 class="text-sm font-bold mb-1">{{ item.supplier_name if item.supplier_name else ('Supplier ' ~ item.supplier_id) }}</h5>
                <p class="text-xs text-slate-500 leading-relaxed">{{ item.ai_insight }}</p>
                <a href="{{ url_for('supplier_detail', supplier_id=item.supplier_id) }}" class="mt-3 inline-block w-full text-center py-2 bg-slate-50 text-slate-700 text-xs font-bold rounded-lg border border-slate-200 hover:bg-slate-100 transition-colors">View Supplier</a>
              </div>
            {% endfor %}
          {% else %}
            <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
              <p class="text-sm text-slate-500">No AI insights available yet. Upload documents to generate insights.</p>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="p-6 border-b border-slate-100">
          <h4 class="text-lg font-bold">Verification Queue</h4>
          <p class="text-sm text-slate-500">Pending supplier submissions that require staff approval.</p>
        </div>
        <div class="p-6 space-y-4">
          {% if verification_queue %}
            {% for item in verification_queue %}
              <div class="rounded-xl border border-slate-200 p-4">
                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                  <div>
                    <p class="text-sm font-bold">{{ item.supplier_name }}</p>
                    <p class="text-xs text-slate-500 mt-1">{{ item.filename }} • {{ item.created_at }} • {{ item.status_label }}</p>
                    <p class="text-xs text-slate-600 mt-2">{{ item.ai_flag_reason }}</p>
                    <div class="mt-3 flex flex-wrap gap-2 text-xs">
                      {% set diesel = item.activity_data.get('diesel_litre', 0) %}
                      {% set electricity = item.activity_data.get('electricity_kwh', 0) %}
                      {% set steel = item.activity_data.get('steel_ton', 0) %}
                      <span class="px-2 py-1 rounded bg-slate-100 border border-slate-200">Diesel: {{ "%.2f"|format(diesel|float) }} L</span>
                      <span class="px-2 py-1 rounded bg-slate-100 border border-slate-200">Electricity: {{ "%.2f"|format(electricity|float) }} kWh</span>
                      <span class="px-2 py-1 rounded bg-slate-100 border border-slate-200">Tonnes: {{ "%.2f"|format(steel|float) }}</span>
                    </div>
                  </div>
                  <div class="flex items-center gap-2">
                    <form action="{{ url_for('approve_document', document_id=item.id) }}" method="post">
                      <button type="submit" class="px-4 py-2 rounded-lg bg-emerald-600 text-white text-sm font-semibold hover:bg-emerald-700">Approve</button>
                    </form>
                    <form action="{{ url_for('reject_document', document_id=item.id) }}" method="post" class="reject-form">
                      <input type="hidden" name="rejection_reason" value="" />
                      <button type="submit" class="px-4 py-2 rounded-lg bg-red-600 text-white text-sm font-semibold hover:bg-red-700">Reject</button>
                    </form>
                  </div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p class="text-sm text-slate-500">No items are currently waiting for verification.</p>
          {% endif %}
        </div>
      </div>

      <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="p-6 border-b border-slate-100 flex justify-between items-center">
          <div>
            <h4 class="text-lg font-bold">Supplier Performance Matrix</h4>
            <p class="text-sm text-slate-500">Benchmark and track performance against sustainability targets.</p>
          </div>
          <a href="{{ url_for('add_supplier') }}" class="flex items-center gap-2 px-5 py-2.5 bg-primary text-white rounded-lg text-sm font-bold hover:shadow-lg hover:shadow-primary/20 transition-all">
            <span class="material-symbols-outlined text-lg">person_add</span>
            <span>Add New Supplier</span>
          </a>
        </div>

        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead class="bg-slate-50">
              <tr>
                <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-slate-400">Supplier Name</th>
                <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-slate-400">Scope 3 Contribution</th>
                <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-slate-400">Status</th>
                <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-slate-400">Risk Level</th>
                <th class="px-6 py-4 text-[11px] font-bold uppercase tracking-wider text-slate-400 text-right">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-slate-100">
              {% for supplier in suppliers %}
              <tr class="hover:bg-slate-50 transition-colors">
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3">
                    <div class="size-8 bg-slate-100 rounded flex items-center justify-center font-bold text-slate-400 text-xs">{{ (supplier.name or 'S')[0] | upper }}</div>
                    <div>
                      <p class="text-sm font-bold">{{ supplier.name }}</p>
                      <p class="text-xs text-slate-500">{{ supplier.category }} • {{ supplier.region }}</p>
                    </div>
                  </div>
                </td>
                <td class="px-6 py-4">
                  <div class="flex items-center gap-3">
                    <div class="w-24 h-2 bg-slate-100 rounded-full overflow-hidden">
                      <div class="bg-primary h-full" style="width: {{ supplier.coverage_pct if supplier.coverage_pct <= 100 else 100 }}%"></div>
                    </div>
                    <span class="text-sm font-semibold">{{ "{:,.2f}".format(supplier.emissions_tco2e) }} tCO2e</span>
                  </div>
                </td>
                <td class="px-6 py-4">
                  {% if supplier.risk_score >= 80 %}
                    <span class="flex items-center gap-1.5 text-xs font-bold text-red-600 bg-red-50 px-2.5 py-1 rounded-full w-fit"><span class="size-1.5 bg-red-600 rounded-full"></span>Critical</span>
                  {% elif supplier.risk_score >= 60 %}
                    <span class="flex items-center gap-1.5 text-xs font-bold text-amber-600 bg-amber-50 px-2.5 py-1 rounded-full w-fit"><span class="size-1.5 bg-amber-600 rounded-full"></span>Needs Attention</span>
                  {% else %}
                    <span class="flex items-center gap-1.5 text-xs font-bold text-emerald-600 bg-violet-50 px-2.5 py-1 rounded-full w-fit"><span class="size-1.5 bg-emerald-600 rounded-full"></span>On Track</span>
                  {% endif %}
                </td>
                <td class="px-6 py-4">
                  <span class="text-xs font-bold {% if supplier.risk_score >= 80 %}text-red-600{% elif supplier.risk_score >= 60 %}text-amber-600{% else %}text-slate-600{% endif %}">
                    {% if supplier.risk_score >= 80 %}Very High{% elif supplier.risk_score >= 60 %}High{% elif supplier.risk_score >= 40 %}Moderate{% else %}Low{% endif %}
                  </span>
                </td>
                <td class="px-6 py-4 text-right">
                  <a href="{{ url_for('supplier_detail', supplier_id=supplier.id) }}" class="text-primary text-sm font-semibold hover:underline">View</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
  (function () {
    const body = document.body;
    const toggleBtn = document.getElementById("sidebarToggle");
    const backdrop = document.getElementById("sidebarBackdrop");
    const SIDEBAR_STATE_KEY = "carbonlens_sidebar_collapsed_{{ (user.email if user and user.email else 'anon') | replace('@', '_') | replace('.', '_') }}";
    const isDesktop = () => window.matchMedia("(min-width: 1024px)").matches;
    const getSavedCollapsed = () => {
      try {
        return localStorage.getItem(SIDEBAR_STATE_KEY) === "1";
      } catch (err) {
        return false;
      }
    };
    const setSavedCollapsed = (value) => {
      try {
        localStorage.setItem(SIDEBAR_STATE_KEY, value ? "1" : "0");
      } catch (err) {
      }
    };
    const applyDesktopState = () => {
      body.classList.toggle("sidebar-collapsed", getSavedCollapsed());
    };

    applyDesktopState();

    if (toggleBtn) {
      toggleBtn.addEventListener("click", () => {
        if (isDesktop()) {
          const nextState = !body.classList.contains("sidebar-collapsed");
          body.classList.toggle("sidebar-collapsed", nextState);
          setSavedCollapsed(nextState);
        } else {
          body.classList.toggle("sidebar-mobile-open");
        }
      });
    }

    if (backdrop) {
      backdrop.addEventListener("click", () => body.classList.remove("sidebar-mobile-open"));
    }

    window.addEventListener("resize", () => {
      if (isDesktop()) {
        body.classList.remove("sidebar-mobile-open");
        applyDesktopState();
      }
    });
  })();
</script>

<script>
  document.querySelectorAll(".reject-form").forEach((form) => {
    form.addEventListener("submit", (event) => {
      const reason = window.prompt("Reason for rejection (optional):", "");
      const input = form.querySelector('input[name="rejection_reason"]');
      if (input) {
        input.value = reason ? reason.trim() : "";
      }
      if (reason === null) {
        event.preventDefault();
      }
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const labels = {{ suppliers | map(attribute='name') | list | tojson }};
  const values = {{ suppliers | map(attribute='emissions_tco2e') | list | tojson }};
  const canvas = document.getElementById('scope3LineChart');

  if (canvas && labels.length) {
    new Chart(canvas, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: 'tCO2e',
          data: values,
          borderColor: '#7F00FF',
          backgroundColor: 'rgba(127,0,255,0.18)',
          fill: true,
          tension: 0.35,
          borderWidth: 3,
          pointRadius: 4,
          pointBackgroundColor: '#7F00FF'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
          y: { beginAtZero: true, grid: { color: 'rgba(148,163,184,0.2)' }, ticks: { color: '#94a3b8' } }
        }
      }
    });
  }
</script>

</body></html>








